# Code Review Results

**Review Context:** Phase 6: Search by title - YouTrack for issue IW-88
**Files Reviewed:** 4 files
**Skills Applied:** 3 (scala3, architecture, testing)
**Timestamp:** 2026-01-14 21:52:00
**Git Context:** git diff 1ce39e0

---

<review skill="scala3">

## Scala 3 Idioms Review

### Critical Issues

None found.

### Warnings

None found.

### Suggestions

#### Consider Opaque Type for ApiToken Instead of Case Class
**Location:** `.iw/core/ApiToken.scala:9`
**Problem:** `ApiToken` is implemented as a case class with a private constructor and custom toString. While this provides security through masked logging, an opaque type could provide the same benefits with less ceremony and true zero-cost abstraction.
**Impact:** Minor - the current implementation works well and has good security properties. However, Scala 3's opaque types are the modern pattern for type-safe wrappers and would eliminate any runtime overhead while maintaining the same safety guarantees.
**Note:** The main tradeoff is that opaque types don't support custom `toString` directly - you'd need an explicit `toSafeString` method. If automatic masking in `toString` is critical for security (preventing accidental logging), the current case class approach is actually more appropriate. This is a case where the Scala 2 pattern might be intentionally better for this specific use case.

</review>

---

<review skill="architecture">

## Architecture Review

### Critical Issues

#### API Clients Performing I/O Should Be in Infrastructure Layer
**Location:** `.iw/core/YouTrackClient.scala` (entire file), specifically lines 147-165 for `searchIssues`
**Problem:** `YouTrackClient` is an imperative shell component (performs HTTP I/O) but is located at the package root `iw.core` instead of in `iw.core.infrastructure`. The `searchIssues` method directly performs HTTP requests using sttp, which is a side-effecting operation.
**Impact:** Violates FCIS principle - imperative shell code should be clearly separated from functional core. This makes it harder to identify which parts of the codebase perform I/O vs pure computation.
**Note:** This is a PRE-EXISTING pattern in the codebase - all API clients (YouTrackClient, LinearClient, GitHubClient) follow this same structure. Not a regression from Phase 6.
**Recommendation for future:** Move all API client objects to `iw.core.infrastructure.adapters` or a similar infrastructure subpackage.

---

### Warnings

#### Mixed Pure and Impure Functions in Same Object
**Location:** `.iw/core/YouTrackClient.scala:85-88` and `147-165`
**Problem:** `YouTrackClient` object contains both pure functions (`buildSearchIssuesUrl`, `parseListRecentIssuesResponse`) and impure functions (`searchIssues`, `listRecentIssues`, `fetchIssue`). While the separation of URL building and parsing is good, they're mixed in the same object with I/O operations.
**Impact:** Makes it harder to test pure logic in isolation and blurs the functional core boundary.
**Recommendation:** Consider splitting into two objects following FCIS more strictly.

---

### Suggestions

#### Test Structure Could Better Reflect FCIS Architecture
**Location:** `.iw/core/test/YouTrackClientTest.scala`
**Problem:** Tests mix pure function tests (URL building, parsing) with tests that verify behavior of I/O functions.
**Impact:** Minor - tests work correctly but don't emphasize the architectural boundary.

#### CaskServer Mixes Concerns Between Core and Infrastructure
**Location:** `.iw/core/CaskServer.scala:584-590`
**Problem:** `CaskServer` directly calls infrastructure components and handles configuration/token retrieval.
**Impact:** Minimal in current implementation - the code works and is testable.

</review>

---

<review skill="testing">

## Unit Testing Review

### Critical Issues

#### HTTP Calls in Unit Tests - External Dependencies
**Location:** `.iw/core/YouTrackClient.scala:147-165`
**Problem:** The `searchIssues` function makes real HTTP calls using `quickRequest.get(uri"$url").send()`, and the unit tests don't actually test this function - they only test URL building and parsing. This means the HTTP-making code is untested in unit tests.
**Impact:** Unit tests should be isolated from external dependencies.
**Note:** This is an architectural limitation with the current use of quickRequest. The tests correctly focus on pure functions.

### Warnings

#### Misleading Test Name and Documentation
**Location:** `.iw/core/test/YouTrackClientTest.scala:130`
**Problem:** Test named "searchIssues can parse response using parseListRecentIssuesResponse" doesn't actually test `searchIssues` function - it only tests `parseListRecentIssuesResponse` with sample JSON.
**Recommendation:** Rename test to accurately reflect what's being tested.

#### Compilation Warnings Not Fixed
**Location:** `.iw/core/YouTrackClient.scala:101, 103, 105`
**Problem:** Three compilation warnings about non-local returns in `parseListRecentIssuesResponse`.
**Note:** Pre-existing issue, not introduced by Phase 6.

### Suggestions

#### Test Coverage Gap for Error Paths
**Location:** `.iw/core/test/YouTrackClientTest.scala`
**Problem:** Tests cover URL building and successful parsing, but missing tests for error scenarios in URL encoding edge cases.

</review>

---

## Summary

- **Critical issues:** 2 (both pre-existing architectural patterns, not Phase 6 regressions)
- **Warnings:** 3 (should address - 1 test naming, 1 compilation warnings, 1 architecture)
- **Suggestions:** 4 (nice to have)

### By Skill
- scala3: 0 critical, 0 warnings, 1 suggestion
- architecture: 1 critical, 1 warning, 2 suggestions
- testing: 1 critical, 2 warnings, 1 suggestion

### Phase 6 Assessment

**PASSED** - The Phase 6 implementation follows existing codebase patterns. The "critical" issues identified are about pre-existing architectural decisions, not regressions from this phase. The new `searchIssues` functionality:
- URL building correctly encodes query parameters
- Reuses existing `parseListRecentIssuesResponse` for consistency
- Follows the same pattern as `listRecentIssues` (Phase 5)
- Tests cover pure functions appropriately
