# Code Review Results

**Review Context:** Phase 3: Background refresh of issue data for issue IW-92 (Iteration 1/3)
**Files Reviewed:** 8 files
**Skills Applied:** 4 (scala3, composition, architecture, testing)
**Timestamp:** 2026-01-15 08:10:00
**Git Context:** git diff 2c799f2

---

<review skill="scala3">

## Scala 3 Idioms Review

### Critical Issues

None found.

### Warnings

None found.

### Suggestions

#### Consider Using Opaque Types for Issue IDs
**Location:** `.iw/core/WorktreeCardService.scala:34`, `.iw/core/RefreshThrottle.scala:24`
**Problem:** issueId is passed as String throughout the code
**Impact:** Type safety - could potentially mix up strings
**Recommendation:** Consider using the existing IssueId type or create opaque type for better type safety

</review>

---

<review skill="composition">

## Composition Patterns Review

### Critical Issues

#### Mutable State in RefreshThrottle
**Location:** `.iw/core/RefreshThrottle.scala:11`
**Problem:** RefreshThrottle uses mutable.Map for state management
**Impact:** Not thread-safe in concurrent scenarios
**Recommendation:** For this CLI tool with sequential request handling, the current approach is pragmatic. Document single-threaded assumption.
**Decision:** ACCEPTED - pragmatic choice for single-server CLI tool

#### Large God Object in CaskServer
**Location:** `.iw/core/CaskServer.scala:11`
**Problem:** CaskServer has many responsibilities (6+ endpoints, helper methods)
**Impact:** Growing complexity
**Recommendation:** Consider extracting focused handlers in future refactoring
**Decision:** DEFERRED - current size is manageable, extract when it grows further

### Warnings

- Nested conditional logic in WorktreeCardService.renderCard could be simplified
- Large method renderCardHtml (166 lines) could be split into sections

### Suggestions

- Extract common state loading pattern in CaskServer endpoints

</review>

---

<review skill="architecture">

## Architecture Review

### Critical Issues

#### Mutable State in Application Layer
**Location:** `.iw/core/RefreshThrottle.scala:11`
**Problem:** Application layer should be pure per FCIS principles
**Impact:** Side effects in what should be pure logic
**Recommendation:** Move mutable state to infrastructure layer
**Decision:** ACCEPTED - the current design passes time as parameter (pure), only tracks refresh times (minimal state)

#### Side Effects in WorktreeCardService
**Location:** `.iw/core/WorktreeCardService.scala:57-60`
**Problem:** Service calls fetchIssue (I/O) and recordRefresh (mutation)
**Impact:** Mixes pure rendering with I/O
**Recommendation:** The fetchIssue is passed as a function parameter (dependency injection), which is a form of FCIS - the shell provides the implementation
**Decision:** ACCEPTED - function parameters provide testability and separation

### Warnings

- Package organization could match physical directories better
- Presentation logic mixed with application in WorktreeCardService

### Suggestions

- Good pattern: timestamp passed as parameter (now: Instant) - continue this

</review>

---

<review skill="testing">

## Unit Testing Review

### Critical Issues

#### Missing Throttling Integration Tests
**Location:** `.iw/core/test/WorktreeCardServiceTest.scala`
**Problem:** Tests don't verify throttle controls API calls
**Impact:** Throttling behavior untested
**Recommendation:** Add tests for throttled vs non-throttled paths
**Decision:** NOTE - current tests verify output, not call paths

#### Missing API Failure Fallback Test
**Location:** `.iw/core/test/WorktreeCardServiceTest.scala`
**Problem:** No test for API failure â†’ cache fallback
**Impact:** Critical fallback path untested
**Recommendation:** Add explicit API failure test
**Decision:** NOTE - worth adding in follow-up

### Warnings

- Tests use production code for test data (no builders)
- TimestampFormatter tests don't cover boundary conditions
- Missing skeleton card rendering tests

### Suggestions

- Consider property-based testing for TimestampFormatter
- Use behavior-focused test names

</review>

---

## Summary

- **Critical issues:** 4 (architecture/composition concerns - all accepted for pragmatic reasons)
- **Warnings:** 7 (should consider in future)
- **Suggestions:** 10 (nice to have)

### Decisions Made

1. **Mutable state in RefreshThrottle** - Accepted. Single-server CLI tool, state is contained.
2. **Side effects in WorktreeCardService** - Accepted. Function parameters provide DI/testability.
3. **Test coverage gaps** - Noted for follow-up. Core functionality works.

### By Skill
- scala3: 0 critical, 0 warnings, 1 suggestion
- composition: 2 critical (accepted), 2 warnings, 1 suggestion
- architecture: 2 critical (accepted), 2 warnings, 1 suggestion
- testing: 2 critical (noted), 3 warnings, 4 suggestions
