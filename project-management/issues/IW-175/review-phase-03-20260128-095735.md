# Code Review Results

**Review Context:** Phase 3: Removed worktrees shift remaining cards predictably for issue IW-175 (Iteration 1/3)
**Files Reviewed:** 1 file
**Skills Applied:** 4 (architecture, scala3, testing, style)
**Timestamp:** 2026-01-28 09:57:35
**Git Context:** git diff HEAD~1

---

<review skill="architecture">

## Architecture Review

### Critical Issues

None found.

### Warnings

None found.

### Suggestions

#### Consider Moving Pure Test Logic to model/ Package
**Location:** `.iw/core/test/WorktreeListSyncTest.scala:417-532`
**Problem:** Tests are placed in `test/` directory at core level, but the functionality being tested (`WorktreeListSync`) is in `dashboard/` package. According to the core module CLAUDE.md, the `dashboard/` module is marked as "Internal API" and scripts in `.iw/commands/*.scala` should NOT import from it.
**Impact:** Minor organizational inconsistency. While the tests are correctly placed in a test directory, the module being tested (`WorktreeListSync`) contains what appears to be pure business logic (`detectChanges`, `findPredecessor`) that could potentially be extracted to `model/` if this logic needs to be reused outside the dashboard context.
**Recommendation:** Current organization is acceptable for dashboard-internal functionality. However, if the diff detection logic in `detectChanges` ever needs to be reused outside the dashboard server, consider extracting the pure algorithmic part to `model/` and keeping only the HTMX-specific HTML generation in `dashboard/`.

This is only a suggestion for future consideration - the current organization is valid for dashboard-internal functionality.

</review>

---

<review skill="scala3">

## Scala 3 Idioms Review

### Critical Issues

None found.

### Warnings

None found.

### Suggestions

#### Consider Using Named Parameters for Complex Test Setup
**Location:** `.iw/core/test/WorktreeListSyncTest.scala:457-485`
**Problem:** Test setup involves multiple Map.empty parameters passed positionally to `generateChangesResponse`, making it hard to understand which Map represents what at a glance.
**Impact:** Reduces test readability - need to count parameters to know which is issueCache, which is branchDataCache, etc.
**Recommendation:** Consider using named parameters for clarity, especially for tests with many Map.empty arguments.

This pattern appears in multiple tests (lines 475-485, 515-525). Named parameters would make the intent clearer without needing to reference the function signature.

#### Empty Collection Syntax Consistency
**Location:** `.iw/core/test/WorktreeListSyncTest.scala:423,433,443`
**Problem:** Mix of `List.empty[String]` (explicit type) and `List.empty` (inferred type) in assertions
**Impact:** Minor inconsistency - both work fine, but consistency improves readability
**Recommendation:** Stick with one style. The inferred version `List.empty` is cleaner when the type is obvious from context.

</review>

---

<review skill="testing">

## Testing Review

### Critical Issues

None found.

### Warnings

#### Incomplete Test Coverage - Edge Case Missing
**Location:** `.iw/core/test/WorktreeListSyncTest.scala:447-455`
**Problem:** Test `detectChanges: delete all cards except one` doesn't verify a critical edge case - deleting the middle card when only one card remains could be ambiguous. More importantly, the test suite is missing a test for "delete all cards" (empty list result).
**Impact:** Edge case behavior is not verified - what happens when `newIds = List.empty` after having multiple cards? This scenario exists in line 63-71 but only with the initial state, not as a deletion-focused test.
**Recommendation:** Add a test that verifies deleting all cards from a non-empty list.

Note: This scenario is technically already tested by line 63-71, but that test name emphasizes "empty new list" rather than the deletion behavior. For Phase 3's focus on deletion behavior, an explicitly named deletion test would improve clarity.

### Suggestions

#### Test Organization - Consider Grouping Phase 3 Tests
**Location:** `.iw/core/test/WorktreeListSyncTest.scala:415-532`
**Problem:** Phase 3 tests are marked with a comment but not grouped into a test suite. The file has grown to 532 lines with multiple phases of tests intermingled.
**Impact:** Minor - tests are clear but organization could be better for long-term maintenance.
**Recommendation:** Consider using munit's nested test suites to group related tests.

This is not critical for this phase but would improve organization if the test file continues to grow.

#### Test Assertion Consistency - Mixed Assertion Styles
**Location:** `.iw/core/test/WorktreeListSyncTest.scala:487-490`
**Problem:** Tests use both positive assertions (`assert(html.contains(...))`) and negative assertions (`assert(!html.contains(...))`) inconsistently. Some tests verify absence of content (line 489-490) while others only verify presence.
**Impact:** Very minor - the negative assertions in the deletion test are actually good (verifying no addition swaps), but this pattern isn't consistently applied elsewhere.
**Recommendation:** Consider adding similar negative assertions to other tests where absence of certain HTML is important behavior.

No action required, but worth noting as a positive pattern that could be applied elsewhere.

#### Test Data Realism - Use Consistent Issue ID Format
**Location:** `.iw/core/test/WorktreeListSyncTest.scala:417-531`
**Problem:** Phase 3 tests use consistent, realistic issue IDs (`IW-100`, `IW-150`, `IW-200`, `IW-250`), which is good. However, earlier tests in the file (lines 12-83) use `IW-1`, `IW-2`, `IW-3` which might not sort correctly in production (should be `IW-001` or `IW-01` for alphabetical sorting to work correctly).
**Impact:** Very minor - existing tests work fine for their purpose, but mixing formats could be confusing.
**Recommendation:** Consider standardizing on three-digit issue IDs throughout the test file for consistency.

This is out of scope for Phase 3 review, but worth noting for future cleanup.

</review>

---

<review skill="style">

## Code Style & Documentation Review

### Formatting (Automated)
- [x] Scalafmt applied: YES (formatting appears consistent)
- Issues: None

### Naming Conventions
- [x] PascalCase for classes/traits/objects: OK
- [x] camelCase for methods/variables: OK
- [x] Meaningful names: OK
- Issues: None found

All test names follow the convention `test("description: specific scenario")` which is clear and descriptive. Variable names like `oldIds`, `newIds`, `changes`, `registrations`, `issueCache`, `html` are all appropriately named.

### Import Organization
- [x] Organized by groups: OK
- [x] No wildcard domain imports: OK
- Issues: None found

### Documentation
- [x] PURPOSE comments present: OK
- [x] Public APIs documented: N/A (test file)
- [x] No temporal comments: OK
- Issues: None found

### Critical Issues

None found.

### Warnings

None found.

### Suggestions

#### Consider More Descriptive Test Names for Edge Cases
**Location:** `.iw/core/test/WorktreeListSyncTest.scala:447`
**Problem:** Test name "delete all cards except one" could be more specific about what's being verified
**Impact:** Minor - test is clear from code, but name could better communicate the assertion
**Recommendation:** Consider a name like "detectChanges: delete all but one card does not reorder remaining"

</review>

---

## Summary

- **Critical issues:** 0 (must fix before merge)
- **Warnings:** 1 (should fix)
- **Suggestions:** 7 (nice to have)

### By Skill
- architecture: 0 critical, 0 warnings, 1 suggestion
- scala3: 0 critical, 0 warnings, 2 suggestions
- testing: 0 critical, 1 warning, 3 suggestions
- style: 0 critical, 0 warnings, 1 suggestion

### Recommendation

**APPROVE** - No critical issues. The single warning about missing "delete all cards" test is noted but the scenario is already covered by existing test `detectChanges handles empty new list - all deletions` (lines 63-71). The suggestions are for future improvements and don't block this phase.
