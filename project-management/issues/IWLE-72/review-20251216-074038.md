# Code Review Results

**Review Context:** Issue IWLE-72 (feature branch) - Full implementation of iw-cli tool
**Files Reviewed:** 45 files (3,087 lines of Scala 3 code)
**Skills Applied:** 7 (architecture, scala3, composition, testing, style, security, error-handling)
**Timestamp:** 2025-12-16 07:40:38
**Git Context:** git diff main..HEAD

---

<review skill="architecture">

## Architecture Review

### Critical Issues

**1. Mutable Global State in DoctorChecks**

**Location:** `.iw/core/DoctorChecks.scala:14-16`

```scala
class DoctorChecksRegistry:
  private var registry: List[Check] = Nil  // MUTABLE STATE

  def register(name: String)(check: ProjectConfiguration => CheckResult): Unit =
    registry = Check(name, check) :: registry  // MUTATION
```

**Impact:** Violates functional programming principles. The global singleton `object DoctorChecks extends DoctorChecksRegistry` compounds this issue.

**Recommendation:** Refactor to immutable builder pattern:

```scala
case class DoctorChecksRegistry(checks: List[Check] = Nil):
  def register(name: String)(check: ProjectConfiguration => CheckResult): DoctorChecksRegistry =
    copy(checks = Check(name, check) :: checks)

  def all: List[Check] = checks.reverse
```

### Warnings

**1. Hardcoded YouTrack URL**

**Location:** `.iw/commands/issue.scala:57`

```scala
val baseUrl = "https://youtrack.e-bs.cz"  // HARDCODED
```

**Recommendation:** Add to ProjectConfiguration or use environment variable.

### Suggestions

1. Add logging infrastructure for debugging
2. Use `given`/`using` for threading configuration
3. Extract magic strings to constants

</review>

---

<review skill="scala3">

## Scala 3 Idioms Review

### Critical Issues

None found.

### Warnings

**1. DoctorChecks Uses Top-Level Vals for Side Effects**

**Location:** `.iw/commands/doctor.scala:13-27`

```scala
val _gitCheck = DoctorChecks.register("Git repository") { _ =>
  // ...
}
```

**Recommendation:** Use explicit registration in object initialization.

### Suggestions

1. Use opaque types for `IssueId` and `ApiToken` (zero runtime overhead)
2. Convert CheckResult enum to ADT-style for explicit hints
3. Use extension methods for Path operations

</review>

---

<review skill="composition">

## Functional Composition Review

### Critical Issues

None found.

### Warnings

None found.

### Suggestions

1. Excellent separation of concerns (domain/infrastructure/application)
2. Consider making DoctorChecks registry functional

</review>

---

<review skill="testing">

## Testing Review

### Critical Issues

None found.

### Warnings

**1. Missing Tests for GitRemote.host Edge Cases**

No dedicated test file for `GitRemote.host` method. Edge cases like malformed URLs aren't tested.

**2. Tests Don't Always Verify Error Messages**

```scala
test("IssueId.parse rejects missing number"):
  val result = IssueId.parse("IWLE-")
  assert(result.isLeft)  // Doesn't check error message
```

### Suggestions

1. Create `GitRemoteTest.scala` for URL parsing
2. Add property-based tests for parsers
3. Extract test fixtures to shared module
4. Add compilation warnings check

</review>

---

<review skill="style">

## Code Style Review

### Critical Issues

None found.

### Warnings

None found.

### Suggestions

1. Extract magic strings to constants object
2. Add Scaladoc to public APIs
3. Consider consistent naming for test helper fixtures

**Positive:** Clear PURPOSE comments in all files, consistent formatting.

</review>

---

<review skill="security">

## Security Review

### Critical Issues

**1. Shell Injection Risk in ProcessAdapter.commandExists**

**Location:** `.iw/core/Process.scala:22`

```scala
val exitCode = s"sh -c 'command -v $command >/dev/null 2>&1'".!
```

**Impact:** Even with SafeCommandPattern validation, string interpolation into shell command is dangerous.

**Recommendation:** Use Process API without shell interpolation:

```scala
def commandExists(command: String): Boolean =
  if !SafeCommandPattern.matches(command) then return false
  try
    Seq("which", command).! == 0
  catch
    case _: Exception => false
```

### Warnings

**1. Missing Null Checks in JSON Parsing**

**Location:** `.iw/core/LinearClient.scala:62-89`

```scala
val id = issueData("identifier").str
```

These will throw on missing fields. Add explicit existence checks.

### Suggestions

1. Use newtype pattern for API tokens to prevent accidental logging
2. Add timeout support to Process.run

</review>

---

<review skill="error-handling">

## Error Handling Review

### Critical Issues

None found.

### Warnings

**1. GitRemote.host Throws Instead of Returning Either**

**Location:** `.iw/core/Config.scala:20`

```scala
throw IllegalArgumentException(s"Unsupported git URL format: $url")
```

**2. ConfigSerializer.fromHocon Throws on Unknown Tracker**

**Location:** `.iw/core/Config.scala:64`

```scala
case other => throw IllegalArgumentException(s"Unknown tracker type: $other")
```

**Recommendation:** Return `Either[String, A]` consistently.

### Suggestions

1. Excellent use of `Either[String, A]` throughout most of codebase
2. Consider adding error context validation to JSON parsing

</review>

---

## Summary

- **Critical issues:** 2 (must fix before merge)
- **Warnings:** 8 (should fix)
- **Suggestions:** 12 (nice to have)

### By Skill
- architecture: 1 critical, 1 warning, 3 suggestions
- scala3: 0 critical, 1 warning, 3 suggestions
- composition: 0 critical, 0 warnings, 2 suggestions
- testing: 0 critical, 2 warnings, 4 suggestions
- style: 0 critical, 0 warnings, 3 suggestions
- security: 1 critical, 1 warning, 2 suggestions
- error-handling: 0 critical, 2 warnings, 2 suggestions

### Critical Issues to Fix

1. **Mutable Global State in DoctorChecks** - Refactor to immutable builder pattern
2. **Shell Injection Risk in ProcessAdapter.commandExists** - Use Process API without shell interpolation

### Positive Findings

- Excellent separation of concerns (domain/infrastructure/application)
- Comprehensive test coverage (20+ test cases for edge cases)
- Consistent use of `Either[String, A]` for error handling
- Smart use of value objects (`IssueId`, `WorktreePath`, `DeletionSafety`)
- Security-conscious design with input validation
- Clear PURPOSE comments in all files
- Thoughtful user experience with helpful error messages

### Recommendation

Address the 2 critical issues, then merge. The warnings and suggestions can be tackled in follow-up iterations. This is production-ready code once critical issues are resolved.
