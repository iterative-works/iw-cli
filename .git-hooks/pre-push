#!/usr/bin/env bash
set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-push checks...${NC}"

# Step 1: Clean compile and check for warnings
echo -e "${YELLOW}Compiling (checking for warnings)...${NC}"
COMPILE_OUTPUT=$(scala-cli compile --force .iw/core/ 2>&1) || {
    echo ""
    echo -e "${RED}┌──────────────────────────────────────────────┐${NC}"
    echo -e "${RED}│  PUSH BLOCKED: Compilation failed            │${NC}"
    echo -e "${RED}├──────────────────────────────────────────────┤${NC}"
    echo -e "${RED}│  Fix compilation errors before pushing.      │${NC}"
    echo -e "${RED}│                                              │${NC}"
    echo -e "${RED}│  Bypass: git push --no-verify                │${NC}"
    echo -e "${RED}│          (not recommended)                   │${NC}"
    echo -e "${RED}└──────────────────────────────────────────────┘${NC}"
    echo "$COMPILE_OUTPUT"
    exit 1
}

if echo "$COMPILE_OUTPUT" | grep -q '\[warn\]'; then
    echo ""
    echo -e "${RED}┌──────────────────────────────────────────────┐${NC}"
    echo -e "${RED}│  PUSH BLOCKED: Compilation warnings found    │${NC}"
    echo -e "${RED}├──────────────────────────────────────────────┤${NC}"
    echo -e "${RED}│  Fix all warnings before pushing.            │${NC}"
    echo -e "${RED}│                                              │${NC}"
    echo -e "${RED}│  Bypass: git push --no-verify                │${NC}"
    echo -e "${RED}│          (not recommended)                   │${NC}"
    echo -e "${RED}└──────────────────────────────────────────────┘${NC}"
    echo "$COMPILE_OUTPUT" | grep '\[warn\]'
    exit 1
fi
echo -e "${GREEN}Compilation passed (no warnings).${NC}"

# Step 2: Run full test suite
echo -e "${YELLOW}Running tests...${NC}"
if ./iw test; then
    echo -e "${GREEN}All tests passed.${NC}"
else
    echo ""
    echo -e "${RED}┌──────────────────────────────────────────────┐${NC}"
    echo -e "${RED}│  PUSH BLOCKED: Tests failed                  │${NC}"
    echo -e "${RED}├──────────────────────────────────────────────┤${NC}"
    echo -e "${RED}│  Fix failing tests before pushing.           │${NC}"
    echo -e "${RED}│  Run: ./iw test                              │${NC}"
    echo -e "${RED}│                                              │${NC}"
    echo -e "${RED}│  Bypass: git push --no-verify                │${NC}"
    echo -e "${RED}│          (not recommended)                   │${NC}"
    echo -e "${RED}└──────────────────────────────────────────────┘${NC}"
    exit 1
fi

echo -e "${GREEN}All pre-push checks passed.${NC}"
