#!/usr/bin/env bash
set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-push checks...${NC}"

# Step 1: Compile core with warnings-as-errors
echo -e "${YELLOW}Compiling core (warnings as errors)...${NC}"
if scala-cli compile --scalac-option -Werror .iw/core/ 2>&1; then
    echo -e "${GREEN}Core compilation passed (no warnings).${NC}"
else
    echo ""
    echo -e "${RED}┌──────────────────────────────────────────────┐${NC}"
    echo -e "${RED}│  PUSH BLOCKED: Core compilation failed       │${NC}"
    echo -e "${RED}├──────────────────────────────────────────────┤${NC}"
    echo -e "${RED}│  Fix compilation errors and warnings in      │${NC}"
    echo -e "${RED}│  .iw/core/ before pushing.                   │${NC}"
    echo -e "${RED}│                                              │${NC}"
    echo -e "${RED}│  Bypass: git push --no-verify                │${NC}"
    echo -e "${RED}│          (not recommended)                   │${NC}"
    echo -e "${RED}└──────────────────────────────────────────────┘${NC}"
    exit 1
fi

# Step 2: Run unit tests and command compilation (E2E deferred to CI)
echo -e "${YELLOW}Running unit tests and command compilation...${NC}"
if ./iw test unit && ./iw test compile; then
    echo -e "${GREEN}Unit tests and compilation passed.${NC}"
else
    echo ""
    echo -e "${RED}┌──────────────────────────────────────────────┐${NC}"
    echo -e "${RED}│  PUSH BLOCKED: Tests failed                  │${NC}"
    echo -e "${RED}├──────────────────────────────────────────────┤${NC}"
    echo -e "${RED}│  Fix failing tests before pushing.           │${NC}"
    echo -e "${RED}│  Run: ./iw test unit && ./iw test compile    │${NC}"
    echo -e "${RED}│                                              │${NC}"
    echo -e "${RED}│  Bypass: git push --no-verify                │${NC}"
    echo -e "${RED}│          (not recommended)                   │${NC}"
    echo -e "${RED}└──────────────────────────────────────────────┘${NC}"
    exit 1
fi

echo -e "${GREEN}All pre-push checks passed.${NC}"
