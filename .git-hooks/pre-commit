#!/usr/bin/env bash
set -euo pipefail

# Git sets GIT_DIR and GIT_WORK_TREE during hook execution. These leak into
# child processes and cause git commands to operate on unexpected repositories.
unset GIT_DIR GIT_WORK_TREE

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit checks...${NC}"

# Format check
echo -e "${YELLOW}Checking code formatting...${NC}"
if scala-cli fmt --check .; then
    echo -e "${GREEN}Format check passed.${NC}"
else
    echo ""
    echo -e "${RED}┌──────────────────────────────────────────────┐${NC}"
    echo -e "${RED}│  COMMIT BLOCKED: Code formatting issues      │${NC}"
    echo -e "${RED}├──────────────────────────────────────────────┤${NC}"
    echo -e "${RED}│  Fix: scala-cli fmt .                        │${NC}"
    echo -e "${RED}│  Then re-stage your changes and commit again │${NC}"
    echo -e "${RED}│                                              │${NC}"
    echo -e "${RED}│  Bypass: git commit --no-verify              │${NC}"
    echo -e "${RED}│          (not recommended)                   │${NC}"
    echo -e "${RED}└──────────────────────────────────────────────┘${NC}"
    exit 1
fi

# Compile core with warnings-as-errors
echo -e "${YELLOW}Compiling core (warnings as errors)...${NC}"
if scala-cli compile --scalac-option -Werror .iw/core/ 2>&1; then
    echo -e "${GREEN}Compilation passed (no warnings).${NC}"
else
    echo ""
    echo -e "${RED}┌──────────────────────────────────────────────┐${NC}"
    echo -e "${RED}│  COMMIT BLOCKED: Compilation errors/warnings │${NC}"
    echo -e "${RED}├──────────────────────────────────────────────┤${NC}"
    echo -e "${RED}│  Fix compilation errors and warnings in      │${NC}"
    echo -e "${RED}│  .iw/core/ before committing.                │${NC}"
    echo -e "${RED}│                                              │${NC}"
    echo -e "${RED}│  Bypass: git commit --no-verify              │${NC}"
    echo -e "${RED}│          (not recommended)                   │${NC}"
    echo -e "${RED}└──────────────────────────────────────────────┘${NC}"
    exit 1
fi
