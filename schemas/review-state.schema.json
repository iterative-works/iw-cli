{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/iterative-works/iw-cli/schemas/review-state.schema.json",
  "title": "Review State",
  "description": "Defines the contract for review-state.json files used by iw-cli workflow tools and the dashboard. Each issue directory contains a review-state.json that tracks the current workflow state. Schema v2 separates structural display concerns from semantic workflow concerns.",
  "type": "object",
  "required": ["version", "issue_id", "artifacts", "last_updated"],
  "additionalProperties": false,
  "properties": {
    "version": {
      "type": "integer",
      "minimum": 1,
      "description": "Schema version number. Version 2 is current. Incremented only for breaking changes (removed fields, changed types)."
    },
    "issue_id": {
      "type": "string",
      "description": "Links the review state to the issue being worked on. Used for file paths and dashboard grouping."
    },
    "status": {
      "type": "string",
      "description": "Machine-readable workflow state identifier for workflow tools. NOT used by dashboard for display - that's what 'display' is for. Examples: implementing, awaiting_review, phase_merged, all_complete. Optional - workflow internal use only."
    },
    "display": {
      "description": "Workflow-controlled presentation instructions. The dashboard renders exactly what it's told without interpretation. If absent, no status badge is shown.",
      "$ref": "#/definitions/display"
    },
    "badges": {
      "type": "array",
      "description": "Additional contextual indicators controlled by the workflow. Allows workflow to add arbitrary labels without dashboard needing to understand them.",
      "items": {
        "$ref": "#/definitions/badge"
      }
    },
    "task_lists": {
      "type": "array",
      "description": "Tells the dashboard which files contain task checkboxes for progress computation. The workflow controls which files matter; the dashboard computes progress from those files.",
      "items": {
        "$ref": "#/definitions/task_list"
      }
    },
    "needs_attention": {
      "type": "boolean",
      "description": "Flag indicating the workflow has stopped and needs human input. Can be set by a Claude hook when the agent stops to ask a question. Dashboard shows visual indicator."
    },
    "message": {
      "type": "string",
      "description": "Prominent notification for the user. This is NOT status metadata - it's an important communication that should catch the user's eye. Examples: 'Please review the options in analysis.md and provide direction', 'Build failed - check CI logs'."
    },
    "artifacts": {
      "type": "array",
      "description": "Documents produced during the workflow that the user may want to review. Required but may be an empty array.",
      "items": {
        "$ref": "#/definitions/artifact"
      },
      "examples": [
        [
          {"label": "Analysis", "path": "project-management/issues/IW-136/analysis.md", "category": "input"},
          {"label": "Implementation Log", "path": "project-management/issues/IW-136/implementation-log.md", "category": "output"}
        ]
      ]
    },
    "available_actions": {
      "type": "array",
      "description": "Actions the user can take from the dashboard. Workflow tells dashboard what buttons to show. Each action maps to a skill that can be invoked.",
      "items": {
        "$ref": "#/definitions/action"
      },
      "examples": [
        [
          {"id": "implement", "label": "Start Implementation", "skill": "iterative-works:ag-implement"},
          {"id": "verify", "label": "Verify Phase", "skill": "iterative-works:ag-verify"}
        ]
      ]
    },
    "last_updated": {
      "type": "string",
      "description": "ISO 8601 timestamp of last modification. Used for cache invalidation and staleness detection.",
      "format": "date-time"
    },
    "pr_url": {
      "description": "Link to the pull request. Dashboard renders this as a clickable 'View PR' button. Null if no PR has been created yet.",
      "oneOf": [
        {"type": "string"},
        {"type": "null"}
      ]
    },
    "git_sha": {
      "type": "string",
      "description": "Records the commit SHA when state was written. Useful for debugging and audit trails. Dashboard may display this for reference."
    },
    "phase_checkpoints": {
      "type": "object",
      "description": "Internal workflow data for revert-to-phase functionality. Maps phase numbers to context file SHAs. Not displayed by dashboard.",
      "additionalProperties": {
        "$ref": "#/definitions/phase_checkpoint"
      },
      "examples": [
        {
          "1": {"context_sha": "7bd547909953d9414b4cd6049a411beb6258ba2b"},
          "2": {"context_sha": "d485a987e378d8193e6a211955e1709725178f00"}
        }
      ]
    }
  },
  "definitions": {
    "display": {
      "type": "object",
      "description": "Workflow-controlled presentation instructions for status badge rendering.",
      "required": ["text", "type"],
      "additionalProperties": false,
      "properties": {
        "text": {
          "type": "string",
          "description": "Primary status label shown in the badge. Workflow decides the wording."
        },
        "subtext": {
          "type": "string",
          "description": "Secondary information shown smaller/muted beneath the badge. For context that supports the main status."
        },
        "type": {
          "type": "string",
          "enum": ["info", "success", "warning", "error", "progress"],
          "description": "Display category that maps to CSS styling. info=neutral (blue), success=positive/complete (green), warning=needs attention (yellow/orange), error=problem/blocked (red), progress=work in progress (blue/animated)."
        }
      }
    },
    "badge": {
      "type": "object",
      "description": "Additional contextual indicator with label and color category.",
      "required": ["label", "type"],
      "additionalProperties": false,
      "properties": {
        "label": {
          "type": "string",
          "description": "Short text shown on the badge."
        },
        "type": {
          "type": "string",
          "enum": ["info", "success", "warning", "error", "progress"],
          "description": "Color category (same enum as display.type)."
        }
      }
    },
    "task_list": {
      "type": "object",
      "description": "Reference to a markdown file containing task checkboxes for progress tracking.",
      "required": ["label", "path"],
      "additionalProperties": false,
      "properties": {
        "label": {
          "type": "string",
          "description": "Human-readable name for the task list (e.g., \"Phase 2 Tasks\", \"Refactoring R1\")."
        },
        "path": {
          "type": "string",
          "description": "Relative path from project root to the markdown file containing checkboxes."
        }
      }
    },
    "artifact": {
      "type": "object",
      "description": "A workflow artifact with a human-readable label and a path relative to the project root.",
      "required": ["label", "path"],
      "additionalProperties": false,
      "properties": {
        "label": {
          "type": "string",
          "description": "Human-readable name of the artifact (e.g., \"Analysis\", \"Implementation Log\")."
        },
        "path": {
          "type": "string",
          "description": "Path to the artifact file, relative to the project root."
        },
        "category": {
          "type": "string",
          "description": "Optional categorization for grouping artifacts in the dashboard. Workflows decide the categories; common values include 'input' (planning documents) and 'output' (execution results)."
        }
      }
    },
    "action": {
      "type": "object",
      "description": "An action that can be offered to the user in the dashboard or CLI.",
      "required": ["id", "label", "skill"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Machine-readable identifier for the action (e.g., \"implement\", \"verify\")."
        },
        "label": {
          "type": "string",
          "description": "Human-readable label displayed to the user (e.g., \"Start Implementation\")."
        },
        "skill": {
          "type": "string",
          "description": "Skill identifier to invoke when the action is triggered (e.g., \"iterative-works:ag-implement\")."
        }
      }
    },
    "phase_checkpoint": {
      "type": "object",
      "description": "Checkpoint data for a single phase, recording the context file SHA for revert support.",
      "required": ["context_sha"],
      "additionalProperties": false,
      "properties": {
        "context_sha": {
          "type": "string",
          "description": "Git blob SHA of the phase context file at the start of that phase."
        }
      }
    }
  }
}
